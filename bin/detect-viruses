#!/bin/bash
# не знаю особенностей grep, но если искать парные скобки, он их интерпретирует не как простой текст и не ищет такие строки
# При добавлении сигнатуры, нужно создать тестовый файл в /root/virustest, который должен детектиться новой сигнатурой.
# Все файлы в этой папке должны обнаружаться!

. $( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/../lib/init
use_config_var "VIRUSES_LOG"
use_config_var "MAILTO"

if [ $# == 0 ]; then
	echo Usage: $0 dir
	echo Run on test directory...
	echo ""
	#exit 1
fi

if [ $# -gt 0 ]; then find_dir="$1"; else find_dir=/root/virustest; fi

echo Search in $find_dir...

# чистим файл
> "$VIRUSES_LOG"

# chr(101 - был вирус на эту строку, но вместе с ним еще 20 нормальных файлов детектится, надо переписать, пример есть в /root/virustest/virus/fancy_shadow_e.php

find "$find_dir" -name "*.php" -exec grep -iHc "$VIRUSES_PHP_SIGNATURES" {} \; | grep -v ":0" >> "$VIRUSES_LOG"
find "$find_dir" -name "*.js" -exec grep -iHc "$VIRUSES_JS_SIGNATURES" {} \; | grep -v ":0" >> "$VIRUSES_LOG"
find "$find_dir" -name ".htaccess" -exec grep -iHc "midp" {} \; | grep -v ":0" >> "$VIRUSES_LOG"
#find "$find_dir" -name "*.pl" >> "$VIRUSES_LOG"

if [ -s "$VIRUSES_LOG" ]; then
	count=$(wc -l "$VIRUSES_LOG")
	mail -s "[alert] server $(hostname), found viruses: $count" "$MAILTO" < "$VIRUSES_LOG"
	echo Found $count viruses!
	cat "$VIRUSES_LOG"
	rm "$VIRUSES_LOG"
else
	echo $find_dir clean.
fi

exit 0
