#!/bin/bash

set -e

. /usr/share/server-scripts/lib/init
use_config_var "DRUPAL_ROOT_LEVEL"
use_config_var "SITE_EXCLUDED_FILE" ".excluded"
use_config_var "SITE_INFO_FILE" ".info"

nginx_sites=$(mktemp -t nginx-sites-XXXX)
trap 'rm -f "$nginx_sites"' EXIT

NO_EMAIL=${NO_EMAIL:-""}


main() {
	grep -R "root " /etc/nginx/sites-enabled \
	 | grep -v '^#' \
	 | cut -d':' -f2 | grep -o "\(\/.*\?\)" | sed 's/[;"]//g'\
	 | sort | uniq \
	 > $nginx_sites

	for root_path in $(cat "$nginx_sites"); do
		hostname=$(hostname -f)
		if [ ! -d "$root_path" ]; then
			user=""
		else
			user=$(stat -c '%U' "$root_path")
		fi
		engine=$(get-engine "$root_path")
		domain=$(get_domain "$root_path")
		email=$(get-email "$root_path")
		if [ "$engine" = "excluded" ]; then continue; fi
		if [ "$root_path" = "/usr/share/nginx/html" ]; then continue; fi
		if [ "$root_path" = "/var/www/html" ]; then continue; fi
 		if [ "$root_path" = "/var/www/example.com" ]; then continue; fi
		echo -e "$root_path\t$hostname\t$user\t$engine\t$domain\t$email"
	done
}

main "$@"
